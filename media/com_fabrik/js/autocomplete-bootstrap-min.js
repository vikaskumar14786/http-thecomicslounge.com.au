var FbAutocomplete=new Class({Implements:[Options,Events],options:{menuclass:"auto-complete-container dropdown",classes:{ul:"dropdown-menu",li:"result"},url:"index.php",max:10,onSelection:Class.empty,autoLoadSingleResult:true,minTriggerChars:1,storeMatchedResultsOnly:false},initialize:function(b,a){window.addEvent("domready",function(){this.matchedResult=false;this.setOptions(a);b=b.replace("-auto-complete","");this.options.labelelement=typeOf(document.id(b+"-auto-complete"))==="null"?document.getElement(b+"-auto-complete"):document.id(b+"-auto-complete");this.cache={};this.selected=-1;this.mouseinsde=false;document.addEvent("keydown",function(c){this.doWatchKeys(c)}.bind(this));this.element=typeOf(document.id(b))==="null"?document.getElement(b):document.id(b);this.buildMenu();if(!this.getInputElement()){fconsole("autocomplete didn't find input element");return}this.getInputElement().setProperty("autocomplete","off");this.getInputElement().addEvent("keyup",function(c){this.search(c)}.bind(this));this.getInputElement().addEvent("blur",function(c){if(this.options.storeMatchedResultsOnly){if(!this.matchedResult){if(typeof(this.data)==="undefined"||!(this.data.length===1&&this.options.autoLoadSingleResult)){this.element.value=""}}}}.bind(this))}.bind(this))},search:function(b){if(!this.isMinTriggerlength()){return}if(b.key==="tab"||b.key==="enter"){b.stop();this.closeMenu();if(this.ajax){this.ajax.cancel()}this.element.fireEvent("change",new Event.Mock(this.element,"change"),500);return}this.matchedResult=false;var a=this.getInputElement().get("value");if(a===""){this.element.value=""}if(a!==this.searchText&&a!==""){if(this.options.storeMatchedResultsOnly===false){this.element.value=a}this.positionMenu();if(this.cache[a]){if(this.populateMenu(this.cache[a])){this.openMenu()}}else{if(this.ajax){this.closeMenu();this.ajax.cancel()}this.ajax=new Request({url:this.options.url,data:{value:a},onRequest:function(){Fabrik.loader.start(this.getInputElement())}.bind(this),onCancel:function(){Fabrik.loader.stop(this.getInputElement());this.ajax=null}.bind(this),onSuccess:function(d){Fabrik.loader.stop(this.getInputElement());this.ajax=null;if(typeOf(d)==="null"){fconsole("Fabrik autocomplete: Ajax response empty");var c=Fabrik.getBlock(this.options.formRef).formElements.get(this.element.id);c.setErrorMessage(Joomla.JText._("COM_FABRIK_AUTOCOMPLETE_AJAX_ERROR"),"fabrikError",true);return}this.completeAjax(d,a)}.bind(this),onFailure:function(d){Fabrik.loader.stop(this.getInputElement());this.ajax=null;fconsole("Fabrik autocomplete: Ajax failure: Code "+d.status+": "+d.statusText);var c=Fabrik.getBlock(this.options.formRef).formElements.get(this.element.id);c.setErrorMessage(Joomla.JText._("COM_FABRIK_AUTOCOMPLETE_AJAX_ERROR"),"fabrikError",true)}.bind(this)}).send()}}this.searchText=a},completeAjax:function(b,a){b=JSON.decode(b);this.cache[a]=b;if(this.populateMenu(b)){this.openMenu()}},buildMenu:function(){this.menu=new Element("ul.dropdown-menu",{role:"menu",styles:{"z-index":1056}});this.menu.inject(document.body);this.menu.addEvent("mouseenter",function(){this.mouseinsde=true}.bind(this));this.menu.addEvent("mouseleave",function(){this.mouseinsde=false}.bind(this));this.menu.addEvent("click:relay(a)",function(b,a){this.makeSelection(b,a)}.bind(this))},getInputElement:function(){return this.options.labelelement?this.options.labelelement:this.element},positionMenu:function(){var a=this.getInputElement().getCoordinates();this.menu.setStyles({left:a.left,top:(a.top+a.height)-1,width:a.width})},populateMenu:function(d){var k,j;d.map(function(i,a){i.text=Encoder.htmlDecode(i.text);return i});this.data=d;var h=this.getListMax();var g=this.menu;g.empty();if(d.length===1&&this.options.autoLoadSingleResult){this.element.value=d[0].value;this.getInputElement().value=d[0].text;this.closeMenu();this.fireEvent("selection",[this,this.element.value]);var b=Fabrik.getBlock(this.options.formRef).formElements.get(this.element.id);var f=b.getBlurEvent();this.element.fireEvent(f,new Event.Mock(this.element,f),700);Fabrik.fireEvent("fabrik.autocomplete.selected",[this,this.element.value]);return false}if(d.length===0){k=new Element("li").adopt(new Element("div.alert.alert-info").adopt(new Element("i").set("text",Joomla.JText._("COM_FABRIK_NO_RECORDS"))));k.inject(g)}for(var e=0;e<h;e++){var c=d[e];j=new Element("a",{href:"#","data-value":c.value,tabindex:"-1"}).set("text",c.text);k=new Element("li").adopt(j);k.inject(g)}if(d.length>this.options.max){new Element("li").set("text","....").inject(g)}return true},makeSelection:function(b,a){b.preventDefault();if(typeOf(a)!=="null"){this.getInputElement().value=a.get("text");this.element.value=a.getProperty("data-value");this.closeMenu();this.fireEvent("selection",[this,this.element.value]);this.element.fireEvent("change",new Event.Mock(this.element,"change"),700);this.element.fireEvent("blur",new Event.Mock(this.element,"blur"),700);Fabrik.fireEvent("fabrik.autocomplete.selected",[this,this.element.value])}else{Fabrik.fireEvent("fabrik.autocomplete.notselected",[this,this.element.value])}},closeMenu:function(){if(this.shown){this.shown=false;this.menu.hide();this.selected=-1;document.removeEvent("click",function(a){this.doTestMenuClose(a)}.bind(this))}},openMenu:function(){if(!this.shown){if(this.isMinTriggerlength()){this.menu.show();this.shown=true;document.addEvent("click",function(a){this.doTestMenuClose(a)}.bind(this));this.selected=0;this.highlight()}}},isMinTriggerlength:function(){var a=this.getInputElement().get("value");return a.length>=this.options.minTriggerChars},doTestMenuClose:function(){if(!this.mouseinsde){this.closeMenu()}},getListMax:function(){if(typeOf(this.data)==="null"){return 0}return this.data.length>this.options.max?this.options.max:this.data.length},doWatchKeys:function(d){if(document.activeElement!==this.getInputElement()){return}var a=this.getListMax(),b,c;if(!this.shown){if(d.code.toInt()===13){d.stop()}if(d.code.toInt()===40){this.openMenu()}}else{if(!this.isMinTriggerlength()){d.stop();this.closeMenu()}else{if(d.key==="enter"||d.key==="tab"){window.fireEvent("blur")}switch(d.code){case 40:if(!this.shown){this.openMenu()}if(this.selected+1<=a){this.selected++}this.highlight();d.stop();break;case 38:if(this.selected-1>=-1){this.selected--;this.highlight()}d.stop();break;case 13:case 9:d.stop();b=this.getSelected();if(b){c=new Event.Mock(b,"click");this.makeSelection(c,b);this.closeMenu()}break;case 27:d.stop();this.closeMenu();break}}}},getSelected:function(){var b=this.menu.getElements("li"),a=b.filter(function(c,d){return d===this.selected}.bind(this));if(typeOf(a[0])==="element"){return a[0].getElement("a")}else{if(b.length>0){return b[0].getElement("a")}}return false},highlight:function(){this.matchedResult=true;this.menu.getElements("li").each(function(a,b){if(b===this.selected){a.addClass("selected").addClass("active")}else{a.removeClass("selected").removeClass("active")}}.bind(this))}});var FabCddAutocomplete=new Class({Extends:FbAutocomplete,search:function(d){var c;var b=this.getInputElement().get("value");if(b===""){this.element.value=""}if(b!==this.searchText&&b!==""){var a=document.id(this.options.observerid);if(typeOf(a)!=="null"){if(this.options.formRef){a=Fabrik.getBlock(this.options.formRef).formElements[this.options.observerid]}c=a.get("value")+"."+b}else{this.parent(d);return}this.positionMenu();if(this.cache[c]){if(this.populateMenu(this.cache[c])){this.openMenu()}}else{if(this.ajax){this.closeMenu();this.ajax.cancel()}this.ajax=new Request({url:this.options.url,data:{value:b,fabrik_cascade_ajax_update:1,v:a.get("value")},onRequest:function(){Fabrik.loader.start(this.getInputElement())}.bind(this),onCancel:function(){Fabrik.loader.stop(this.getInputElement())}.bind(this),onSuccess:function(f){Fabrik.loader.stop(this.getInputElement());this.ajax=null;this.completeAjax(f)}.bind(this),onFailure:function(f){Fabrik.loader.stop(this.getInputElement());this.ajax=null;fconsole("Fabrik autocomplete: Ajax failure: Code "+f.status+": "+f.statusText);var e=Fabrik.getBlock(this.options.formRef).formElements.get(this.element.id);e.setErrorMessage(Joomla.JText._("COM_FABRIK_AUTOCOMPLETE_AJAX_ERROR"),"fabrikError",true)}.bind(this)}).send()}}this.searchText=b}});